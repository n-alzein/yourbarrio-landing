"use client";

import Image from "next/image";
import Link from "next/link";
import { useRouter, useSearchParams } from "next/navigation";
import { useEffect, useMemo, useRef, useState } from "react";
import {
  ChevronDown,
  Loader2,
  MapPin,
  PackageSearch,
  Search,
  Store,
} from "lucide-react";
import { useTheme } from "@/components/ThemeProvider";
import CartNavActionClient from "@/components/nav/CartNavActionClient";
import HeaderAccountWidget from "@/components/nav/HeaderAccountWidget";
import { BUSINESS_CATEGORIES, normalizeCategoryName } from "@/lib/businessCategories";
import {
  getAvailabilityBadgeStyle,
  normalizeInventory,
  sortListingsByAvailability,
} from "@/lib/inventory";
import { AUTH_UI_RESET_EVENT } from "@/components/AuthProvider";
import { useLocation } from "@/components/location/LocationProvider";
import {
  getLocationLabel,
  isZipLike,
  normalizeSelectedLocation,
  setLocationSearchParams,
} from "@/lib/location";
import { markNavInProgress } from "@/lib/nav/safariNavGuard";

const SEARCH_CATEGORIES = ["All", ...BUSINESS_CATEGORIES.map((cat) => cat.name)];

const getInitialSearchTerm = (params) => (params?.get("q") || "").trim();

const getInitialCategory = (params) => {
  const currentCategory = (params?.get("category") || "").trim();
  const normalizedCurrent = normalizeCategoryName(currentCategory).toLowerCase();
  const matchedCategory = SEARCH_CATEGORIES.find(
    (category) => normalizeCategoryName(category).toLowerCase() === normalizedCurrent
  );
  return matchedCategory || "All";
};

export default function GlobalHeader({ surface = "public", showSearch = true }) {
  const searchParams = useSearchParams();
  const router = useRouter();
  const { theme, hydrated } = useTheme();
  const isLight = hydrated ? theme === "light" : true;
  const { location, hasLocation, setLocation } = useLocation();
  const [mobileMenuOpen, setMobileMenuOpen] = useState(false);
  const mobileDrawerId = useMemo(
    () => `global-mobile-drawer-${surface || "public"}`,
    [surface]
  );

  const [searchTerm, setSearchTerm] = useState(() => getInitialSearchTerm(searchParams));
  const [selectedCategory, setSelectedCategory] = useState(() => getInitialCategory(searchParams));
  const [locationOpen, setLocationOpen] = useState(false);
  const [locationInput, setLocationInput] = useState("");
  const [locationSuggestions, setLocationSuggestions] = useState([]);
  const [locationSuggestLoading, setLocationSuggestLoading] = useState(false);
  const [locationSuggestError, setLocationSuggestError] = useState(null);
  const [locationSuggestIndex, setLocationSuggestIndex] = useState(-1);
  const [locationSelectHint, setLocationSelectHint] = useState(null);
  const [searchResults, setSearchResults] = useState({
    items: [],
    businesses: [],
    places: [],
  });
  const [searchLoading, setSearchLoading] = useState(false);
  const [searchError, setSearchError] = useState(null);
  const [suggestionsOpen, setSuggestionsOpen] = useState(false);
  const searchBoxRef = useRef(null);
  const searchInputRef = useRef(null);
  const locationRef = useRef(null);
  const locationPrefillRef = useRef(false);
  const locationSuggestAbortRef = useRef(null);
  const locationSuggestReqIdRef = useRef(0);
  const locationSuggestSpinnerRef = useRef(null);
  const locationSuggestShownAtRef = useRef(0);
  const searchRequestIdRef = useRef(0);
  const lastQueryRef = useRef("");
  // Location display derives only from the global provider state.
  const locationLabel = getLocationLabel(location);
  const locationNoMatchMessage = isZipLike(locationInput)
    ? "No matches. Try another postal code."
    : "No matches. Try another city.";

  const sortedSearchItems = useMemo(
    () => sortListingsByAvailability(searchResults.items || []),
    [searchResults.items]
  );

  const baseSearchPath = surface === "customer" ? "/customer/home" : "/listings";
  const listingPath = surface === "customer" ? "/customer/listings" : "/listings";
  const logoHref = surface === "customer" ? "/customer/home" : "/";

  const hasHybridResults =
    (searchResults.items?.length || 0) +
      (searchResults.businesses?.length || 0) +
      (searchResults.places?.length || 0) >
    0;

  const navigateToSearch = (query, category) => {
    const value = (query || "").trim();
    const nextCategory = (category || "").trim();
    const params = new URLSearchParams();
    if (value) params.set("q", value);
    if (nextCategory && nextCategory !== "All") params.set("category", nextCategory);
    const withLocation = setLocationSearchParams(params, location);
    const target = withLocation.toString()
      ? `${baseSearchPath}?${withLocation.toString()}`
      : baseSearchPath;
    setSuggestionsOpen(false);
    router.push(target);
  };

  const handleSubmitSearch = (event) => {
    event.preventDefault();
    navigateToSearch(searchTerm || "", selectedCategory);
  };

  const handleCategoryChange = (event) => {
    const next = event.target.value;
    setSelectedCategory(next);
    navigateToSearch(searchTerm || "", next);
  };

  const handleSuggestionSelect = (value, itemId) => {
    const next = (value || "").trim();
    if (!next) return;
    setSearchTerm(next);
    setSuggestionsOpen(false);
    if (itemId) {
      const params = setLocationSearchParams(new URLSearchParams(), location);
      const suffix = params.toString();
      router.push(suffix ? `${listingPath}/${itemId}?${suffix}` : `${listingPath}/${itemId}`);
      return;
    }
    navigateToSearch(next, selectedCategory);
  };

  const categorySelectWidth = Math.max(selectedCategory.length, 3) + 6;

  // Hybrid search — fetch AI-style blend of items + businesses
  useEffect(() => {
    const term = searchTerm.trim();
    if (term.length < 3) {
      queueMicrotask(() => {
        setSearchResults({ items: [], businesses: [], places: [] });
        setSearchError(null);
        setSearchLoading(false);
        setSuggestionsOpen(false);
      });
      lastQueryRef.current = "";
      return;
    }

    if (!hasLocation) {
      queueMicrotask(() => {
        setSearchResults({ items: [], businesses: [], places: [] });
        setSearchError("Select a location to search.");
        setSearchLoading(false);
        setSuggestionsOpen(false);
      });
      lastQueryRef.current = "";
      return;
    }

    const locationKey = location.city || "none";
    const normalized = `${term.toLowerCase()}::${selectedCategory.toLowerCase()}::${locationKey.toLowerCase()}`;
    if (normalized === lastQueryRef.current) {
      queueMicrotask(() => {
        setSuggestionsOpen(true);
      });
      return;
    }

    const controller = new AbortController();
    const requestId = ++searchRequestIdRef.current;

    const handle = setTimeout(() => {
      queueMicrotask(() => {
        setSearchLoading(true);
        setSearchError(null);
      });
      const categoryParam = selectedCategory !== "All" ? selectedCategory : "";
      const params = new URLSearchParams();
      params.set("q", term);
      if (categoryParam) params.set("category", categoryParam);
      if (location.city) {
        params.set("city", location.city);
      }
      fetch(`/api/search?${params.toString()}`, {
        signal: controller.signal,
      })
        .then(async (res) => {
          if (!res.ok) {
            let message = "search_failed";
            try {
              const body = await res.json();
              message = body?.message || body?.error || message;
            } catch {
              // best effort
            }
            const err = new Error(message);
            err.code = res.status;
            throw err;
          }
          return res.json();
        })
        .then((data) => {
          if (searchRequestIdRef.current !== requestId) return;
          lastQueryRef.current = normalized;
          setSearchResults({
            items: data?.items || [],
            businesses: data?.businesses || [],
            places: data?.places || [],
          });
          setSuggestionsOpen(true);
        })
        .catch((err) => {
          if (controller.signal.aborted) return;
          if (searchRequestIdRef.current !== requestId) return;
          const isRateLimited =
            err?.code === 429 || err?.message === "rate_limit_exceeded";
          setSearchError(
            isRateLimited
              ? "You are searching too fast. Please wait a moment."
              : err?.message || "Search is warming up. Try again in a moment."
          );
        })
        .finally(() => {
          if (searchRequestIdRef.current === requestId) {
            setSearchLoading(false);
          }
        });
    }, 450);

    return () => {
      clearTimeout(handle);
      controller.abort();
    };
  }, [searchTerm, selectedCategory, hasLocation, location.city]);

  // Close AI suggestions when clicking away
  useEffect(() => {
    if (!suggestionsOpen) return;
    const handleClick = (event) => {
      if (searchBoxRef.current && !searchBoxRef.current.contains(event.target)) {
        setSuggestionsOpen(false);
      }
    };
    document.addEventListener("mousedown", handleClick);
    document.addEventListener("touchstart", handleClick);
    return () => {
      document.removeEventListener("mousedown", handleClick);
      document.removeEventListener("touchstart", handleClick);
    };
  }, [suggestionsOpen]);

  useEffect(() => {
    if (!locationOpen) return undefined;
    const handleClickOutside = (event) => {
      if (!locationRef.current?.contains(event.target)) {
        setLocationOpen(false);
      }
    };
    const handleEscape = (event) => {
      if (event.key === "Escape") {
        setLocationOpen(false);
      }
    };
    document.addEventListener("mousedown", handleClickOutside);
    document.addEventListener("keydown", handleEscape);
    return () => {
      document.removeEventListener("mousedown", handleClickOutside);
      document.removeEventListener("keydown", handleEscape);
    };
  }, [locationOpen]);

  useEffect(() => {
    let timeoutId = null;
    if (!locationOpen) {
      locationPrefillRef.current = false;
      return;
    }
    if (locationPrefillRef.current) return;
    locationPrefillRef.current = true;
    timeoutId = setTimeout(() => {
      setLocationInput(locationLabel !== "Your city" ? locationLabel : "");
    }, 0);
    return () => {
      if (timeoutId) clearTimeout(timeoutId);
    };
  }, [locationOpen, locationLabel]);

  useEffect(() => {
    const scheduled = new Set();
    const schedule = (fn) => {
      const id = setTimeout(fn, 0);
      scheduled.add(id);
    };
    const clearScheduled = () => {
      scheduled.forEach((id) => clearTimeout(id));
      scheduled.clear();
    };
    const abortInflight = () => {
      if (locationSuggestAbortRef.current) {
        locationSuggestAbortRef.current.abort();
        locationSuggestAbortRef.current = null;
      }
    };

    // Clear delayed spinner timer on every run (ONLY clear timer)
    if (locationSuggestSpinnerRef.current) {
      clearTimeout(locationSuggestSpinnerRef.current);
      locationSuggestSpinnerRef.current = null;
    }

    if (!locationOpen) {
      abortInflight();
      locationSuggestReqIdRef.current += 1; // invalidate pending
      locationSuggestShownAtRef.current = 0;
      schedule(() => setLocationSuggestLoading(false));
      schedule(() => setLocationSuggestError(null));
      schedule(() => setLocationSuggestIndex(-1));
      schedule(() => setLocationSuggestions([]));
      schedule(() => setLocationSelectHint(null));
      return clearScheduled;
    }

    const term = locationInput.trim();

    // If user cleared input, clear suggestions.
    if (term.length === 0) {
      abortInflight();
      locationSuggestReqIdRef.current += 1;
      locationSuggestShownAtRef.current = 0;
      schedule(() => setLocationSuggestLoading(false));
      schedule(() => setLocationSuggestError(null));
      schedule(() => setLocationSuggestIndex(-1));
      schedule(() => setLocationSuggestions([]));
      schedule(() => setLocationSelectHint(null));
      return clearScheduled;
    }

    // If term is short (1 char), keep last suggestions to prevent flicker.
    if (term.length < 2) {
      abortInflight();
      locationSuggestReqIdRef.current += 1;
      locationSuggestShownAtRef.current = 0;
      schedule(() => setLocationSuggestLoading(false));
      schedule(() => setLocationSuggestError(null));
      schedule(() => setLocationSuggestIndex(-1));
      schedule(() => setLocationSelectHint(null));
      return clearScheduled;
    }

    const reqId = ++locationSuggestReqIdRef.current;

    abortInflight();
    const controller = new AbortController();
    locationSuggestAbortRef.current = controller;

    // Delay spinner so it doesn't flash on fast responses.
    locationSuggestSpinnerRef.current = setTimeout(() => {
      if (reqId !== locationSuggestReqIdRef.current) return;
      locationSuggestShownAtRef.current = Date.now();
      setLocationSuggestLoading(true);
    }, 150);

    const handle = setTimeout(() => {
      setLocationSuggestError(null);

      const debug = process.env.NODE_ENV !== "production";
      const url = debug
        ? `/api/location-suggest?q=${encodeURIComponent(term)}&debug=1`
        : `/api/location-suggest?q=${encodeURIComponent(term)}`;

      fetch(url, { signal: controller.signal })
        .then(async (res) => {
          const data = await res.json().catch(() => ({}));
          if (!res.ok) {
            throw new Error(data?.error || "location_suggest_failed");
          }
          return data;
        })
        .then((data) => {
          if (controller.signal.aborted) return;
          if (reqId !== locationSuggestReqIdRef.current) return;
          const next = Array.isArray(data?.suggestions) ? data.suggestions : [];
          setLocationSuggestions(next);
          setLocationSuggestIndex(-1);
          setLocationSelectHint(null);
          if (data?.error) {
            setLocationSuggestError(data.error);
          }
        })
        .catch((err) => {
          if (controller.signal.aborted) return;
          if (reqId !== locationSuggestReqIdRef.current) return;
          setLocationSuggestError(err?.message || "Location suggestions unavailable.");
          setLocationSuggestions([]);
          setLocationSuggestIndex(-1);
          setLocationSelectHint(null);
        })
        .finally(() => {
          if (controller.signal.aborted) return;
          if (reqId !== locationSuggestReqIdRef.current) return;
          if (locationSuggestSpinnerRef.current) {
            clearTimeout(locationSuggestSpinnerRef.current);
            locationSuggestSpinnerRef.current = null;
          }
          const shownAt = locationSuggestShownAtRef.current || 0;
          const elapsed = shownAt ? Date.now() - shownAt : 9999;
          const remaining = 300 - elapsed;

          if (remaining > 0) {
            setTimeout(() => {
              if (controller.signal.aborted) return;
              if (reqId !== locationSuggestReqIdRef.current) return;
              setLocationSuggestLoading(false);
            }, remaining);
          } else {
            setLocationSuggestLoading(false);
          }
        });
    }, 250);

    return () => {
      clearScheduled();
      clearTimeout(handle);
      controller.abort();
      if (locationSuggestSpinnerRef.current) {
        clearTimeout(locationSuggestSpinnerRef.current);
        locationSuggestSpinnerRef.current = null;
      }
    };
  }, [locationOpen, locationInput]);

  const applyLocationSuggestion = (suggestion) => {
    if (!suggestion) return;
    // We store city as the canonical location to match DB schema; zip is only used for lookup.
    setLocation(normalizeSelectedLocation(suggestion), { replace: true });
    setLocationInput("");
    setLocationSuggestions([]);
    setLocationSuggestIndex(-1);
    setLocationSelectHint(null);
    setLocationOpen(false);
  };

  useEffect(() => {
    if (typeof window === "undefined") return undefined;
    const handleReset = () => {
      setMobileMenuOpen(false);
      setSuggestionsOpen(false);
    };
    window.addEventListener(AUTH_UI_RESET_EVENT, handleReset);
    return () => window.removeEventListener(AUTH_UI_RESET_EVENT, handleReset);
  }, []);

  return (
    <nav
      className="fixed top-0 inset-x-0 z-[5000] theme-lock pointer-events-auto yb-navbar yb-navbar-bordered"
      data-nav-surface={surface}
      data-nav-guard="1"
    >
      <div className="w-full px-5 sm:px-6 md:px-8 lg:px-10 xl:px-14 flex items-center justify-between h-20 gap-6">
        <button
          onClick={() => setMobileMenuOpen((open) => !open)}
          className="md:hidden text-white mr-1"
          aria-label="Open menu"
          aria-expanded={mobileMenuOpen}
          aria-controls={mobileDrawerId}
        >
          <svg className="h-7 w-7" fill="none" stroke="currentColor">
            <path strokeWidth="2" d="M4 6h16M4 12h16M4 18h16" />
          </svg>
        </button>
        <Link
          href={logoHref}
          aria-label="Go to home"
          className="touch-manipulation"
          onPointerDownCapture={() => markNavInProgress(logoHref)}
        >
          <span className="relative block h-10 w-10 md:hidden">
            <Image
              src="/business-placeholder2.png"
              alt="YourBarrio"
              fill
              sizes="40px"
              priority
              className="object-contain"
            />
          </span>
          <span className="relative hidden h-10 w-10 md:block md:h-32 md:w-32">
            <Image
              src="/logo.png"
              alt="YourBarrio"
              fill
              sizes="128px"
              priority
              className="object-contain"
            />
          </span>
        </Link>

        <div className="relative hidden md:flex items-center" ref={locationRef}>
          <button
            type="button"
            onClick={() => setLocationOpen((open) => !open)}
            className="flex items-center gap-2 rounded-xl border border-white/15 bg-white/10 px-3 py-2 text-left text-white/90 transition hover:bg-white/15"
            aria-haspopup="dialog"
            aria-expanded={locationOpen}
          >
            <MapPin className="h-4 w-4 text-white/80" />
            <div className="leading-tight">
              <div className="text-sm font-semibold">{locationLabel}</div>
            </div>
            <ChevronDown className="h-4 w-4 text-white/70" />
          </button>

          {locationOpen ? (
            <div className="absolute left-0 top-full z-50 mt-3 w-72 rounded-2xl p-4 yb-dropdown-surface">
              <div className="text-xs uppercase tracking-[0.22em] yb-dropdown-title">Set location</div>
              <div className="mt-2 text-sm yb-dropdown-muted">Enter a city or ZIP code.</div>
              <div className="mt-4 flex items-center gap-2">
                <input
                  type="text"
                  value={locationInput}
                  onChange={(event) => {
                    setLocationInput(event.target.value);
                    setLocationSelectHint(null);
                  }}
                  onKeyDown={(event) => {
                    if (event.key === "ArrowDown") {
                      event.preventDefault();
                      setLocationSuggestIndex((prev) =>
                        Math.min(prev + 1, locationSuggestions.length - 1)
                      );
                      return;
                    }
                    if (event.key === "ArrowUp") {
                      event.preventDefault();
                      setLocationSuggestIndex((prev) => Math.max(prev - 1, 0));
                      return;
                    }
                    if (event.key === "Enter") {
                      event.preventDefault();
                      if (locationSuggestions.length > 0) {
                        const selected =
                          locationSuggestIndex >= 0 &&
                          locationSuggestions[locationSuggestIndex]
                            ? locationSuggestions[locationSuggestIndex]
                            : locationSuggestions[0];
                        applyLocationSuggestion(selected);
                        return;
                      }
                      setLocationSelectHint("Select a suggestion to set your location.");
                    }
                  }}
                  placeholder="e.g. Austin, 78701"
                  className="w-40 min-w-0 rounded-lg border border-white/10 bg-white/5 px-3 py-2 text-base md:text-sm focus:outline-none focus:ring-2 focus:ring-white/20"
                />
              </div>
              <div className="mt-3 text-xs yb-dropdown-muted min-h-[16px]">
                {locationSuggestLoading ? "Searching locations..." : ""}
              </div>
              {locationSuggestError ? (
                <div className="mt-3 text-xs text-rose-200">{locationSuggestError}</div>
              ) : null}
              {locationSelectHint ? (
                <div className="mt-2 text-xs yb-dropdown-muted">{locationSelectHint}</div>
              ) : null}
              {!locationSuggestLoading &&
              !locationSuggestError &&
              locationInput.trim().length >= 2 &&
              locationSuggestions.length === 0 ? (
                <div className="mt-3 text-xs yb-dropdown-muted">
                  {locationNoMatchMessage}
                </div>
              ) : null}
              {locationSuggestions.length > 0 ? (
                <div className="mt-3 rounded-xl border border-white/10 bg-white/5 p-1">
                  {locationSuggestions.map((suggestion, idx) => (
                    <button
                      key={suggestion.id || suggestion.label || idx}
                      type="button"
                      onClick={() => applyLocationSuggestion(suggestion)}
                      className={`w-full text-left px-3 py-2 text-sm rounded-lg yb-dropdown-item ${
                        idx === locationSuggestIndex ? "bg-white/10" : ""
                      }`}
                    >
                      {suggestion.label}
                    </button>
                  ))}
                </div>
              ) : null}
            </div>
          ) : null}
        </div>

        {showSearch ? (
          <div className="md:hidden flex-1" data-nav-guard="1">
            <form
              onSubmit={handleSubmitSearch}
              className="relative flex w-[calc(100%-3rem)] items-center gap-3 rounded-xl border border-white/15 bg-white/10 px-3 py-2"
            >
              <Search className="h-4 w-4 text-white/70" />
              <input
                id="global-nav-search-mobile"
                name="search"
                value={searchTerm}
                onChange={(e) => setSearchTerm(e.target.value)}
                className="flex-1 bg-transparent pr-12 text-base md:text-sm placeholder:text-white/60 focus:outline-none"
                placeholder="Search YourBarrio"
                type="search"
              />
              <button
                type="submit"
                aria-label="Search"
                className="absolute right-2 top-1/2 -translate-y-1/2 rounded-lg bg-white p-1.5 text-black yb-navbar-light"
              >
                <Search className="h-4 w-4" />
              </button>
            </form>
          </div>
        ) : null}

        {showSearch ? (
          <div className="hidden md:flex flex-1 justify-center" data-nav-guard="1">
            <div ref={searchBoxRef} className="w-full max-w-3xl relative" data-nav-guard="1">
            <form
              onSubmit={handleSubmitSearch}
              className="flex flex-1 items-stretch rounded-2xl overflow-hidden border border-white/15 bg-white/10"
            >
                <div className="hidden lg:flex items-center gap-2 px-3 text-xs font-semibold uppercase tracking-[0.12em] text-white/70 bg-white/5 border-r border-white/10">
                  <label htmlFor="global-search-category" className="sr-only">
                    Category
                  </label>
                  <div className="relative">
                    <select
                      id="global-search-category"
                      value={selectedCategory}
                      onChange={handleCategoryChange}
                      style={{ width: `${categorySelectWidth}ch` }}
                      className="appearance-none bg-transparent pr-7 text-base md:text-xs font-semibold uppercase tracking-[0.12em] text-white/80 focus:outline-none"
                    >
                      {SEARCH_CATEGORIES.map((category) => (
                        <option key={category} value={category} className="text-black">
                          {category}
                        </option>
                      ))}
                    </select>
                    <ChevronDown className="pointer-events-none absolute right-0 top-1/2 h-3 w-3 -translate-y-1/2 text-white/60" />
                  </div>
                </div>
                <div className="relative flex-1">
                  <Search className="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-white/60" />
                  <input
                    id="global-nav-search"
                    name="search"
                    ref={searchInputRef}
                    value={searchTerm}
                    onChange={(e) => setSearchTerm(e.target.value)}
                    onFocus={() => setSuggestionsOpen(hasHybridResults || searchTerm.trim().length > 0)}
                    className="w-full bg-transparent py-3 pl-11 pr-3 text-sm text-white placeholder:text-white/60 focus:outline-none"
                    placeholder="Search tacos, coffee, salons, groceries..."
                    type="search"
                  />
                </div>
                <button
                  type="submit"
                  className="px-5 bg-white text-sm font-semibold text-black hover:bg-white/90 transition yb-navbar-light"
                >
                  Search
                </button>
              </form>

              {suggestionsOpen && (searchLoading || searchError || hasHybridResults) ? (
                <div className="absolute left-0 right-0 top-full mt-2 z-50">
                <div className="rounded-2xl p-3 yb-dropdown-surface">
                  {searchError ? (
                      <div className="rounded-lg bg-white/5 border border-white/10 px-3 py-2 text-xs text-rose-200 mb-2">
                        {searchError}
                      </div>
                    ) : null}

                    <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                      <div className="space-y-2">
                        <div className="flex items-center gap-2 text-xs uppercase tracking-[0.18em] yb-dropdown-muted">
                          <PackageSearch className="h-4 w-4" />
                          Items
                          {searchLoading ? (
                            <Loader2 className="h-3 w-3 animate-spin yb-dropdown-muted" />
                          ) : null}
                        </div>
                        <div className="space-y-2">
                          {sortedSearchItems.slice(0, 4).map((item) => {
                            const inventory = normalizeInventory(item);
                            const badgeStyle = getAvailabilityBadgeStyle(
                              inventory.availability,
                              isLight
                            );
                            return (
                              <button
                                key={`item-${item.id}`}
                                type="button"
                                onClick={() => handleSuggestionSelect(item.title, item.id)}
                                className="w-full text-left rounded-xl border border-white/10 bg-white/5 px-3 py-3 transition flex items-start gap-3 yb-dropdown-item"
                              >
                                <div className="h-10 w-10 rounded-lg bg-white/10 border border-white/10 flex items-center justify-center text-[11px] font-semibold text-white/80">
                                  {item.category
                                    ? item.category.slice(0, 3).toUpperCase()
                                    : "AI"}
                                </div>
                                <div className="flex-1">
                                  <div className="text-sm font-semibold leading-snug">{item.title}</div>
                                  <div className="text-[11px] yb-dropdown-muted">
                                    {item.category || "Local listing"}
                                    {item.price ? ` · $${item.price}` : ""}
                                  </div>
                                  <span
                                    className="mt-2 inline-flex items-center rounded-full border bg-transparent px-2 py-1 text-[10px] font-semibold"
                                    style={
                                      badgeStyle
                                        ? { color: badgeStyle.color, borderColor: badgeStyle.border }
                                        : undefined
                                    }
                                  >
                                    {inventory.label}
                                  </span>
                                </div>
                              </button>
                            );
                          })}
                        </div>
                      </div>

                      <div className="space-y-2">
                        <div className="flex items-center gap-2 text-xs uppercase tracking-[0.18em] yb-dropdown-muted">
                          <Store className="h-4 w-4" />
                          Businesses & places
                        </div>
                        <div className="space-y-2">
                          {(searchResults.businesses || []).slice(0, 3).map((biz) => (
                            <button
                              key={`biz-${biz.id}`}
                              type="button"
                              onClick={() => handleSuggestionSelect(biz.name)}
                              className="w-full text-left rounded-xl border border-white/10 bg-white/5 px-3 py-3 transition flex items-start gap-3 yb-dropdown-item"
                            >
                              <div className="h-10 w-10 rounded-lg bg-emerald-500/20 border border-emerald-200/30 flex items-center justify-center">
                                <Store className="h-4 w-4 text-emerald-200" />
                              </div>
                              <div className="flex-1">
                                <div className="text-sm font-semibold leading-snug">{biz.name}</div>
                                <div className="text-[11px] yb-dropdown-muted">
                                  {biz.category || "Local business"}
                                  {biz.city ? ` · ${biz.city}` : ""}
                                </div>
                              </div>
                            </button>
                          ))}

                          {(searchResults.places || []).slice(0, 3).map((place) => (
                            <button
                              key={`place-${place.id}`}
                              type="button"
                              onClick={() => handleSuggestionSelect(place.name)}
                              className="w-full text-left rounded-xl border border-white/10 bg-white/5 px-3 py-3 transition flex items-start gap-3 yb-dropdown-item"
                            >
                              <div className="h-10 w-10 rounded-lg bg-blue-500/20 border border-blue-200/30 flex items-center justify-center">
                                <MapPin className="h-4 w-4 text-blue-100" />
                              </div>
                              <div className="flex-1">
                                <div className="text-sm font-semibold leading-snug">{place.name}</div>
                                <div className="text-[11px] yb-dropdown-muted">
                                  {place.address || "Nearby result"}
                                </div>
                              </div>
                            </button>
                          ))}
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              ) : null}
            </div>
          </div>
        ) : (
          <div className="hidden md:flex flex-1" />
        )}

        <div className="hidden md:flex items-center gap-8">
          <CartNavActionClient />
          <HeaderAccountWidget surface={surface} variant="desktop" />
        </div>

      </div>

      <HeaderAccountWidget
        surface={surface}
        variant="mobile"
        mobileMenuOpen={mobileMenuOpen}
        onCloseMobileMenu={() => setMobileMenuOpen(false)}
        mobileDrawerId={mobileDrawerId}
      />
    </nav>
  );
}
