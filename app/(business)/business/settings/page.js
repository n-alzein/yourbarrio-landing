"use client";

import { useState, useEffect, useRef } from "react";
import { useAuth } from "@/components/AuthProvider";
import SafeImage from "@/components/SafeImage";
import { useRouter } from "next/navigation";
import {
  getAuthProviderLabel,
  getPrimaryAuthProvider,
} from "@/lib/getAuthProvider";
import { PATHS } from "@/lib/auth/paths";
import {
  Field,
  FieldGrid,
  SettingsSection,
  inputClassName,
} from "@/components/settings/SettingsSection";

export default function SettingsPage() {
  const { user, profile, supabase, loadingUser, logout, refreshProfile } =
    useAuth();
  const router = useRouter();

  /* -----------------------------------------------------------
     HOOKS (always first — no conditional hooks)
  ----------------------------------------------------------- */
  const [saving, setSaving] = useState(false);
  const [editMode, setEditMode] = useState(false);
  const [photoUploading, setPhotoUploading] = useState(false);
  const [fieldErrors, setFieldErrors] = useState({});
  const [toast, setToast] = useState(null);
  const toastTimerRef = useRef(null);

  const buildInitialForm = (profile) => ({
    full_name: profile?.business_name || profile?.full_name || "",
    phone: profile?.phone || "",
    city: profile?.city || "",
    address: profile?.address || "",
    address_2: profile?.address_2 || "",
    state: profile?.state ? profile.state.toUpperCase() : "",
    postal_code: profile?.postal_code || "",
    website: profile?.website || "",
    profile_photo_url: profile?.profile_photo_url || "",
  });

  const [form, setForm] = useState(() => buildInitialForm(profile));
  const lastUserIdRef = useRef(profile?.id ?? null);

  const showToast = (type, message) => {
    setToast({ type, message });
    if (toastTimerRef.current) {
      clearTimeout(toastTimerRef.current);
    }
    toastTimerRef.current = setTimeout(() => {
      setToast(null);
    }, 3500);
  };

  const handleFieldChange = (key, value) => {
    setForm((prev) => ({ ...prev, [key]: value }));
    setFieldErrors((prev) => {
      if (!prev[key]) return prev;
      const next = { ...prev };
      delete next[key];
      return next;
    });
  };

  const normalizeAddressPayload = (values) => {
    const trimValue = (value) => (value ?? "").trim();
    const stateValue = trimValue(values.state).toUpperCase();
    const postalValue = trimValue(values.postal_code);
    return {
      address: trimValue(values.address),
      address_2: trimValue(values.address_2),
      city: trimValue(values.city),
      state: stateValue,
      postal_code: postalValue,
    };
  };

  const validateAddressFields = (values) => {
    const errors = {};
    const hasStreet = Boolean(values.address);
    const hasCity = Boolean(values.city);
    const hasState = Boolean(values.state);
    const hasPostal = Boolean(values.postal_code);

    if ((hasCity || hasState || hasPostal) && !hasStreet) {
      errors.address =
        "Street address is required when city, state, or postal code is filled.";
    }

    if ((hasState || hasPostal) && !hasCity) {
      errors.city = "City is required when state or postal code is filled.";
    }

    if (hasState && !/^[A-Z]{2}$/.test(values.state)) {
      errors.state = "Use a 2-letter state code (e.g., CA).";
    }

    if (
      hasPostal &&
      !/^[0-9]{5}(-[0-9]{4})?$/.test(values.postal_code)
    ) {
      errors.postal_code = "Use ZIP or ZIP+4 (e.g., 94107 or 94107-1234).";
    }

    return errors;
  };

  useEffect(() => {
    return () => {
      if (toastTimerRef.current) clearTimeout(toastTimerRef.current);
    };
  }, []);

  /* -----------------------------------------------------------
     LOAD PROFILE INTO FORM
  ----------------------------------------------------------- */
  useEffect(() => {
    if (!profile?.id) return;
    if (lastUserIdRef.current === profile.id) return;
    lastUserIdRef.current = profile.id;
    queueMicrotask(() => {
      setForm(buildInitialForm(profile));
    });
  }, [profile]);

  useEffect(() => {
    if (loadingUser) return;
    if (!user) {
      router.replace(PATHS.public.businessLanding);
    }
  }, [loadingUser, router, user]);

  /* -----------------------------------------------------------
     SAVE CHANGES
  ----------------------------------------------------------- */
  async function handleSave() {
    if (!user) return;
    const normalizedAddress = normalizeAddressPayload(form);
    const validationErrors = validateAddressFields(normalizedAddress);

    if (Object.keys(validationErrors).length > 0) {
      setFieldErrors(validationErrors);
      showToast("error", "Fix the highlighted address fields.");
      return;
    }

    setSaving(true);
    setFieldErrors({});

    const { error } = await supabase
      .from("users")
        .update({
          full_name: form.full_name,
          business_name: form.full_name,
          phone: form.phone,
          city: normalizedAddress.city || null,
          address: normalizedAddress.address || null,
          address_2: normalizedAddress.address_2 || null,
          state: normalizedAddress.state || null,
          postal_code: normalizedAddress.postal_code || null,
          website: form.website,
          profile_photo_url: form.profile_photo_url,
        })
      .eq("id", user.id);

    setSaving(false);
    setEditMode(false);

    if (!error) {
      refreshProfile();
      showToast("success", "Settings updated.");
      return;
    }

    showToast("error", error.message || "Failed to save settings.");
  }

  /* -----------------------------------------------------------
     DELETE ACCOUNT
  ----------------------------------------------------------- */
  async function handleDeleteAccount() {
    if (!user) return;

    if (!confirm("Are you sure you want to permanently delete your account?"))
      return;

    await supabase.from("users").delete().eq("id", user.id);
    await supabase.auth.admin.deleteUser(user.id);

    await logout();
  }

  /* -----------------------------------------------------------
     PHOTO UPLOAD
  ----------------------------------------------------------- */
  async function handlePhotoUpload(e) {
    const file = e.target.files?.[0];
    if (!file) return;

    setPhotoUploading(true);

    const fileName = `${user.id}-${Date.now()}`;

    const { error } = await supabase.storage
      .from("business-photos")
      .upload(fileName, file);

    if (!error) {
      supabase.storage.from("business-photos").getPublicUrl(fileName);

      setForm((prev) => ({
        ...prev,
        profile_photo_url: `business-photos/${fileName}`,
      }));
    }

    setPhotoUploading(false);
  }

  /* -----------------------------------------------------------
     CHANGE DETECTION
  ----------------------------------------------------------- */
  const hasChanges =
    profile &&
    JSON.stringify(form) !==
        JSON.stringify(buildInitialForm(profile));

  const primaryProvider = getPrimaryAuthProvider(user);
  const providerLabel = getAuthProviderLabel(user);
  const userEmail = user?.email || profile?.email || "";
  const providerName = primaryProvider
    ? primaryProvider === "email" || primaryProvider === "google"
      ? userEmail || "Email"
      : primaryProvider.charAt(0).toUpperCase() + primaryProvider.slice(1)
    : userEmail || "Email";

  /* -----------------------------------------------------------
     DEBUG (dev only) — trace provider sources
  ----------------------------------------------------------- */
  useEffect(() => {
    if (process.env.NODE_ENV !== "development") return;

    const storedLoginMethod = (() => {
      try {
        return localStorage.getItem("loginMethod");
      } catch {
        return null;
      }
    })();

    const storedProvider = (() => {
      try {
        return localStorage.getItem("provider");
      } catch {
        return null;
      }
    })();

    console.debug("[Settings:business] auth provider debug", {
      resolvedProvider: primaryProvider,
      providerLabel,
      sessionUserId: user?.id,
      sessionUserEmail: user?.email,
      app_metadata: user?.app_metadata,
      user_metadata: user?.user_metadata,
      profileProvider: {
        provider: profile?.provider,
        auth_provider: profile?.auth_provider,
        signup_method: profile?.signup_method,
      },
      storedLoginMethod,
      storedProvider,
    });
  }, [primaryProvider, profile, providerLabel, user]);

  /* -----------------------------------------------------------
     UI GUARD
  ----------------------------------------------------------- */
  if (loadingUser) {
    return <div className="min-h-screen bg-black" />;
  }

  if (!user) {
    return null;
  }

  /* -----------------------------------------------------------
     UI START
  ----------------------------------------------------------- */
  return (
    <div className="min-h-screen text-white relative">
      {/* BACKGROUND */}
      <div className="absolute inset-0 -z-10">
        <div className="absolute inset-0 bg-[#05010d]" />
        <div className="absolute inset-0 bg-gradient-to-b from-purple-900/40 via-fuchsia-900/30 to-black" />
      </div>

      <div className="mx-auto max-w-4xl px-4 py-8 sm:px-6 sm:py-10 lg:px-8">
        <div className="mb-8 flex flex-col gap-4 sm:flex-row sm:items-start sm:justify-between">
          <div>
            <h1 className="text-3xl font-semibold tracking-tight sm:text-4xl">
              Settings
            </h1>
            <p className="text-sm text-white/60 sm:text-base">
              Manage your profile, address, and preferences.
            </p>
          </div>
          {!editMode ? (
            <button
              onClick={() => {
                setEditMode(true);
                setFieldErrors({});
              }}
              className="inline-flex h-11 items-center justify-center rounded-xl border border-white/20 bg-white/10 px-5 text-sm font-semibold text-white transition hover:bg-white/15"
            >
              Edit profile
            </button>
          ) : null}
        </div>

        <div className="space-y-8">
          <SettingsSection
            title="Profile"
            description="Update details that appear on your business profile."
          >
            <div className="flex flex-col gap-6 md:flex-row md:items-start">
              <div className="flex flex-col items-center gap-3 md:items-start">
                <SafeImage
                  src={
                    form.profile_photo_url ||
                    profile?.profile_photo_url ||
                    "/customer-placeholder.png"
                  }
                  alt="Profile Photo"
                  width={132}
                  height={132}
                  className="h-[132px] w-[132px] rounded-2xl border border-white/15 object-cover"
                />
                {editMode ? (
                  <label className="cursor-pointer text-sm font-medium text-pink-300 hover:text-pink-200">
                    Change photo
                    <input
                      type="file"
                      className="hidden"
                      onChange={handlePhotoUpload}
                    />
                  </label>
                ) : null}
              </div>

              <div className="flex-1 space-y-5">
                <FieldGrid className="sm:grid-cols-2">
                  <Field label="Business name" id="full_name">
                    {editMode ? (
                      <input
                        id="full_name"
                        type="text"
                        value={form.full_name}
                        onChange={(e) =>
                          handleFieldChange("full_name", e.target.value)
                        }
                        className={inputClassName}
                      />
                    ) : (
                      <div className="flex h-11 items-center rounded-xl border border-white/10 bg-white/5 px-3 text-sm text-white/80">
                        {form.full_name || "—"}
                      </div>
                    )}
                  </Field>

                  <Field label="Phone number" id="phone">
                    {editMode ? (
                      <input
                        id="phone"
                        type="tel"
                        value={form.phone}
                        onChange={(e) =>
                          handleFieldChange("phone", e.target.value)
                        }
                        className={inputClassName}
                      />
                    ) : (
                      <div className="flex h-11 items-center rounded-xl border border-white/10 bg-white/5 px-3 text-sm text-white/80">
                        {form.phone || "—"}
                      </div>
                    )}
                  </Field>
                </FieldGrid>

                <Field label="Website" id="website">
                  {editMode ? (
                    <input
                      id="website"
                      type="url"
                      value={form.website}
                      onChange={(e) =>
                        handleFieldChange("website", e.target.value)
                      }
                      className={inputClassName}
                    />
                  ) : (
                    <div className="flex h-11 items-center rounded-xl border border-white/10 bg-white/5 px-3 text-sm text-white/80">
                      {form.website || "—"}
                    </div>
                  )}
                </Field>
              </div>
            </div>
          </SettingsSection>

          <SettingsSection
            title="Address"
            description="Make it easy for customers to find you."
            footer={
              editMode ? (
                <>
                  <button
                    onClick={handleSave}
                    disabled={!hasChanges || saving}
                    className={`inline-flex h-11 items-center justify-center rounded-xl px-5 text-sm font-semibold transition ${
                      hasChanges
                        ? "bg-white text-black hover:bg-gray-200"
                        : "cursor-not-allowed bg-white/20 text-white/40"
                    }`}
                  >
                    {saving ? "Saving..." : "Save changes"}
                  </button>
                  <button
                    onClick={() => {
                      setEditMode(false);
                      setForm(buildInitialForm(profile));
                      setFieldErrors({});
                    }}
                    className="inline-flex h-11 items-center justify-center rounded-xl border border-white/20 bg-white/5 px-5 text-sm font-semibold text-white transition hover:bg-white/10"
                  >
                    Cancel
                  </button>
                </>
              ) : null
            }
          >
            <FieldGrid className="sm:grid-cols-2">
              <Field
                label="Street address"
                id="address"
                helper="Required if city, state, or ZIP is set."
                error={fieldErrors.address}
              >
                {editMode ? (
                  <input
                    id="address"
                    type="text"
                    value={form.address}
                    onChange={(e) =>
                      handleFieldChange("address", e.target.value)
                    }
                    placeholder="123 Pine St"
                    className={`${inputClassName} ${
                      fieldErrors.address
                        ? "border-rose-400 focus-visible:ring-rose-400/60"
                        : ""
                    }`}
                    aria-invalid={Boolean(fieldErrors.address)}
                  />
                ) : (
                  <div className="flex h-11 items-center rounded-xl border border-white/10 bg-white/5 px-3 text-sm text-white/80">
                    {form.address || "—"}
                  </div>
                )}
              </Field>

              <Field
                label="Apt / Suite / Unit"
                id="address_2"
                helper="Optional, for multi-tenant buildings or suites."
              >
                {editMode ? (
                  <input
                    id="address_2"
                    type="text"
                    value={form.address_2}
                    onChange={(e) =>
                      handleFieldChange("address_2", e.target.value)
                    }
                    placeholder="Suite 210"
                    className={inputClassName}
                  />
                ) : (
                  <div className="flex h-11 items-center rounded-xl border border-white/10 bg-white/5 px-3 text-sm text-white/80">
                    {form.address_2 || "—"}
                  </div>
                )}
              </Field>
            </FieldGrid>

            <FieldGrid className="sm:grid-cols-3">
              <Field
                label="City"
                id="city"
                helper="Required if state or ZIP is set."
                error={fieldErrors.city}
              >
                {editMode ? (
                  <input
                    id="city"
                    type="text"
                    value={form.city}
                    onChange={(e) => handleFieldChange("city", e.target.value)}
                    placeholder="Long Beach"
                    className={`${inputClassName} ${
                      fieldErrors.city
                        ? "border-rose-400 focus-visible:ring-rose-400/60"
                        : ""
                    }`}
                    aria-invalid={Boolean(fieldErrors.city)}
                  />
                ) : (
                  <div className="flex h-11 items-center rounded-xl border border-white/10 bg-white/5 px-3 text-sm text-white/80">
                    {form.city || "—"}
                  </div>
                )}
              </Field>

              <Field
                label="State"
                id="state"
                helper="Two-letter code."
                error={fieldErrors.state}
              >
                {editMode ? (
                  <input
                    id="state"
                    type="text"
                    value={form.state}
                    onChange={(e) =>
                      handleFieldChange(
                        "state",
                        e.target.value.toUpperCase()
                      )
                    }
                    placeholder="CA"
                    maxLength={2}
                    className={`${inputClassName} ${
                      fieldErrors.state
                        ? "border-rose-400 focus-visible:ring-rose-400/60"
                        : ""
                    }`}
                    aria-invalid={Boolean(fieldErrors.state)}
                  />
                ) : (
                  <div className="flex h-11 items-center rounded-xl border border-white/10 bg-white/5 px-3 text-sm text-white/80">
                    {form.state || "—"}
                  </div>
                )}
              </Field>

              <Field
                label="Postal code"
                id="postal_code"
                helper="ZIP or ZIP+4 format."
                error={fieldErrors.postal_code}
              >
                {editMode ? (
                  <input
                    id="postal_code"
                    type="text"
                    value={form.postal_code}
                    onChange={(e) =>
                      handleFieldChange("postal_code", e.target.value)
                    }
                    placeholder="90802"
                    className={`${inputClassName} ${
                      fieldErrors.postal_code
                        ? "border-rose-400 focus-visible:ring-rose-400/60"
                        : ""
                    }`}
                    aria-invalid={Boolean(fieldErrors.postal_code)}
                  />
                ) : (
                  <div className="flex h-11 items-center rounded-xl border border-white/10 bg-white/5 px-3 text-sm text-white/80">
                    {form.postal_code || "—"}
                  </div>
                )}
              </Field>
            </FieldGrid>
          </SettingsSection>

          <SettingsSection
            title="Security"
            description="Manage how you access your account."
          >
            <div className="flex flex-col gap-3 rounded-xl border border-white/10 bg-white/5 px-4 py-4 sm:flex-row sm:items-center sm:justify-between">
              <div>
                <p className="text-sm font-semibold text-white">
                  {providerName}
                </p>
                <p className="text-sm text-white/60">
                  Signed in via {providerLabel}
                </p>
              </div>
              <button
                disabled
                className="inline-flex h-11 items-center justify-center rounded-xl border border-white/10 bg-white/5 px-4 text-sm font-semibold text-white/40"
              >
                Manage
              </button>
            </div>
          </SettingsSection>

          <SettingsSection
            title="Account"
            description="Actions that affect your account status."
          >
            <button
              onClick={handleDeleteAccount}
              className="inline-flex items-center text-sm font-semibold text-rose-300 hover:text-rose-200"
            >
              Delete account permanently
            </button>
          </SettingsSection>
        </div>
      </div>

      {toast ? (
        <div className="fixed bottom-6 right-6 z-50">
          <div
            className={`rounded-xl px-4 py-3 text-sm font-semibold shadow-lg ${
              toast.type === "success"
                ? "bg-emerald-500 text-white"
                : "bg-rose-500 text-white"
            }`}
          >
            {toast.message}
          </div>
        </div>
      ) : null}
    </div>
  );
}
