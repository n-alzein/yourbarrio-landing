<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <meta http-equiv="Content-Style-Type" content="text/css">
  <title></title>
  <meta name="Generator" content="Cocoa HTML Writer">
  <meta name="CocoaVersion" content="2685.3">
  <style type="text/css">
    p.p1 {margin: 0.0px 0.0px 0.0px 0.0px; font: 11.0px Arial}
    p.p2 {margin: 0.0px 0.0px 0.0px 0.0px; font: 11.0px Arial; min-height: 12.0px}
  </style>
</head>
<body>
<p class="p1">YourBarrio Website Report (Non-Developer Friendly)</p>
<p class="p2"><br></p>
<p class="p1">Table of Contents</p>
<p class="p1">1. Executive Summary</p>
<p class="p1">2. Architecture &amp; Main Entry Points</p>
<p class="p1">3. Website Map (by Persona)</p>
<p class="p1">4. Authentication &amp; Authorization</p>
<p class="p1">5. Data Model &amp; Supabase</p>
<p class="p1">6. Storage &amp; Uploads</p>
<p class="p1">7. Operational Flows (Step-by-Step)</p>
<p class="p1">8. Where to Make Updates</p>
<p class="p1">9. Admin/Operator Playbook</p>
<p class="p1">10. Open Questions / Assumptions</p>
<p class="p1">11. 10-Item Checklist</p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p1">Executive Summary</p>
<p class="p1">YourBarrio is a Next.js App Router web app backed by Supabase for auth, database (Postgres + RLS), realtime messaging, and storage. It supports three visible personas: Public visitors, Customers, and Businesses. There is no admin UI in this repo, but there are admin-only API routes (e.g., geocoding). Content for some banners comes from Strapi (CMS). Maps and address lookups use Mapbox or Google Geocoding if configured.</p>
<p class="p2"><br></p>
<p class="p1">The app uses both server-side and client-side data fetching. Some pages read directly from Supabase in the browser; others go through API routes. This mixed model makes auth cookies and RLS policies the most sensitive parts of the system.</p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p1">Architecture &amp; Main Entry Points</p>
<p class="p2"><br></p>
<p class="p1">App Router Structure (Core Shells)</p>
<p class="p1">- Root layout: app/layout.js</p>
<p class="p1">- Public shell: app/(public)/layout.js</p>
<p class="p1">- Customer shell (role-guarded): app/(customer)/layout.js</p>
<p class="p1">- Business shell (role-guarded): app/(business)/layout.js</p>
<p class="p1">- Account shell (role-guarded): app/account/layout.js</p>
<p class="p1">- Orders shell (customer header): app/orders/layout.js</p>
<p class="p2"><br></p>
<p class="p1">Auth &amp; Session Controls</p>
<p class="p1">- Middleware gatekeeping: middleware.js</p>
<p class="p1">- Server role enforcement: lib/auth/server.js</p>
<p class="p1">- Client auth state: components/AuthProvider.jsx</p>
<p class="p1">- Client fallback redirect: components/auth/AuthRedirectGuard.jsx</p>
<p class="p1">- Cookie logic: lib/authCookies.js</p>
<p class="p1">- Supabase server client (cookies): lib/supabaseServer.js</p>
<p class="p1">- Supabase browser client: lib/supabaseClient.js</p>
<p class="p1">- Supabase service role (server-only): lib/supabase/server.js</p>
<p class="p1">- Public (no-cookie) server client: lib/supabasePublicServer.js</p>
<p class="p2"><br></p>
<p class="p1">API / Route Handlers (Server)</p>
<p class="p1">All route handlers live in app/api/*. Key ones:</p>
<p class="p1">- Auth: app/api/auth/*, app/api/logout/route.js</p>
<p class="p1">- Listings: app/api/home-listings/route.js, app/api/search/route.js</p>
<p class="p1">- Cart / Orders: app/api/cart/route.js, app/api/orders/route.js, app/api/business/orders/route.js</p>
<p class="p1">- Messaging: app/api/customer/*, app/api/business/*</p>
<p class="p1">- Business analytics: app/api/business/dashboard/route.js, app/api/business/views/route.js</p>
<p class="p1">- Admin geocode: app/api/admin/geocode-missing/route.js</p>
<p class="p2"><br></p>
<p class="p1">Shared UI / Components</p>
<p class="p1">- Global headers/nav: components/nav/GlobalHeader.jsx, components/navbars/*</p>
<p class="p1">- Auth modals: components/modals/*</p>
<p class="p1">- Business profile system: components/business/profile/*</p>
<p class="p1">- Public business profile: components/publicBusinessProfile/*</p>
<p class="p1">- Cart system: components/cart/CartProvider.jsx</p>
<p class="p1">- Messaging UI: components/messages/*</p>
<p class="p2"><br></p>
<p class="p1">Configuration / Environment</p>
<p class="p1">- Next config: next.config.mjs</p>
<p class="p1">- Tailwind: tailwind.config.js</p>
<p class="p1">- Env values: .env.local (not inspected for secrets)</p>
<p class="p1">- Strapi integration: lib/strapi.ts, components/banners/StrapiBannersServer.tsx</p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p1">Website Map (by Persona)</p>
<p class="p2"><br></p>
<p class="p1">Where to update: Route files live in app/.../page.js(x) and shared UI in components/...</p>
<p class="p2"><br></p>
<p class="p1">Public (No Login Required)</p>
<p class="p2"><br></p>
<p class="p1">Route | Purpose | Who can access | Data read/write | Code location</p>
<p class="p1">/ | Marketing landing | Anyone | Reads Strapi banner; no DB write | app/(public)/(marketing)/page.js, components/HomeBanner.tsx, components/marketing/HomePageClient.jsx</p>
<p class="p1">/about | Marketing about | Anyone | No DB | app/(public)/(marketing)/about/page.js</p>
<p class="p1">/privacy | Privacy policy | Anyone | No DB | app/(public)/(marketing)/privacy/page.js</p>
<p class="p1">/terms | Terms | Anyone | No DB | app/(public)/(marketing)/terms/page.js</p>
<p class="p1">/business | Business marketing | Anyone | No DB | app/(public)/business/page.js</p>
<p class="p1">/business/about | Business about | Anyone | No DB | app/(public)/business/about/page.js</p>
<p class="p1">/business/login | Business login landing | Anyone | No DB | app/(public)/business/login/page.js</p>
<p class="p1">/business-auth/login | Business login | Anyone | Supabase Auth | app/(public)/business-auth/login/page.js, components/business-auth/BusinessLoginClient.jsx</p>
<p class="p1">/business-auth/register | Business registration | Anyone | Supabase Auth + users table | app/(public)/business-auth/register/page.js, components/business-auth/BusinessRegisterClient.jsx</p>
<p class="p1">/listings | Public listings | Anyone | Reads listings | app/(public)/listings/page.js</p>
<p class="p1">/listings/[id] | Listing detail | Anyone (extra features for logged-in) | Reads listings, users; writes saved_listings, conversations, messages, carts | app/(public)/listings/[id]/page.js</p>
<p class="p1">/b/[id] | Public business profile | Anyone | Reads users, listings, business_reviews, business_gallery_photos, business_announcements; writes business_views | app/(public)/(marketing)/b/[id]/page.jsx</p>
<p class="p1">/profile | Basic profile editor | Logged-in users | Writes users.full_name | app/(public)/profile/page.js</p>
<p class="p1">/oauth/callback | OAuth bridge | Auth callback | No DB | app/(public)/oauth/callback/route.js</p>
<p class="p2"><br></p>
<p class="p1">Customer (Logged-in “customer” role)</p>
<p class="p2"><br></p>
<p class="p1">Route | Purpose | Who can access | Data read/write | Code location</p>
<p class="p1">/customer/home | Customer home feed | Customers | Reads via /api/home-listings | app/(customer)/customer/home/page.js, app/api/home-listings/route.js</p>
<p class="p1">/customer/nearby | Nearby businesses map | Customers | Reads /api/public-businesses, /api/reverse-geocode | app/(customer)/customer/nearby/page.js, app/api/public-businesses/route.js</p>
<p class="p1">/customer/listings/[id] | Listing detail (customer shell) | Customers | Same as public listing | app/(customer)/customer/listings/[id]/page.js</p>
<p class="p1">/customer/saved | Saved listings | Customers | Reads saved_listings + listings | app/(customer)/customer/saved/page.js, app/(customer)/customer/saved/CustomerSavedClient.jsx</p>
<p class="p1">/customer/messages | Inbox | Customers | Reads conversations | app/(customer)/customer/messages/page.js</p>
<p class="p1">/customer/messages/[conversationId] | Message thread | Customers | Reads/writes messages; realtime | app/(customer)/customer/messages/[conversationId]/page.js</p>
<p class="p1">/customer/settings | Account settings | Customers | Updates users + avatar storage | app/(customer)/customer/settings/page.js</p>
<p class="p1">/customer/onboarding | Customer onboarding | Customers | Placeholder | app/(customer)/customer/onboarding/page.js</p>
<p class="p1">/customer/about | Customer info page | Customers | Static | app/(customer)/customer/about/page.js</p>
<p class="p1">/customer/b/[id] | Business profile in customer shell | Customers | Same as /b/[id] | app/(customer)/customer/b/[id]/page.js</p>
<p class="p2"><br></p>
<p class="p1">Customer Operations (Outside /customer, still customer persona)</p>
<p class="p2"><br></p>
<p class="p1">Route | Purpose | Who can access | Data read/write | Code location</p>
<p class="p1">/cart | Cart management | Any logged-in user | Reads/writes carts, cart_items | app/cart/page.js, app/api/cart/route.js</p>
<p class="p1">/checkout | Checkout (submit order) | Any logged-in user | Creates orders, order_items; updates carts | app/checkout/page.js, app/api/orders/route.js</p>
<p class="p1">/orders/[order_number] | Order receipt | Customers | Reads orders, order_items | app/orders/[order_number]/page.js</p>
<p class="p1">/account/orders | Active orders | Customers | Reads orders | app/account/orders/page.js</p>
<p class="p1">/account/purchase-history | Completed orders | Customers | Reads orders | app/account/purchase-history/page.js</p>
<p class="p2"><br></p>
<p class="p1">Business (Logged-in “business” role)</p>
<p class="p2"><br></p>
<p class="p1">Route | Purpose | Who can access | Data read/write | Code location</p>
<p class="p1">/business/dashboard | Business analytics | Businesses | Reads orders, business_views, listings | app/(business)/business/dashboard/page.tsx, app/api/business/dashboard/route.js</p>
<p class="p1">/business/listings | Listings list | Businesses | Reads listings | app/(business)/business/listings/page.js, app/api/business/listings/route.js</p>
<p class="p1">/business/listings/new | Create listing | Businesses | Writes listings; uploads to listing-photos | app/(business)/business/listings/new/page.jsx</p>
<p class="p1">/business/listings/[id]/edit | Edit listing | Businesses | Updates listings; uploads to listing-photos | app/(business)/business/listings/[id]/edit/page.js</p>
<p class="p1">/business/orders | Order management | Businesses | Reads/updates orders; writes notifications, messages; updates inventory | app/(business)/business/orders/page.js, app/api/business/orders/route.js</p>
<p class="p1">/business/messages | Inbox | Businesses | Reads conversations | app/(business)/business/messages/page.js</p>
<p class="p1">/business/messages/[conversationId] | Message thread | Businesses | Reads/writes messages; realtime | app/(business)/business/messages/[conversationId]/page.js</p>
<p class="p1">/business/profile | Public profile editor | Businesses | Updates users; uses business_gallery_photos, business_reviews, business_announcements | app/(business)/business/profile/page.js, components/business/profile/*</p>
<p class="p1">/business/settings | Account settings | Businesses | Updates users; uploads to business-photos | app/(business)/business/settings/page.js</p>
<p class="p1">/business/onboarding | Business onboarding | Businesses | Updates users + mapbox lookup | app/(business)/business/onboarding/page.js</p>
<p class="p1">/business/preview | Preview public profile | Businesses | Reads profile + public profile data | app/(business)/business/preview/page.js</p>
<p class="p2"><br></p>
<p class="p1">Admin / Debug / Internal</p>
<p class="p2"><br></p>
<p class="p1">Route | Purpose | Access | Data | Code location</p>
<p class="p1">/debug/crashlog | Crash logging view | Internal use | Crash logs | app/debug/crashlog/page.js</p>
<p class="p1">/api/admin/geocode-missing | Admin geocode batch | Token-protected | Updates users/businesses coords | app/api/admin/geocode-missing/route.js</p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p1">Authentication &amp; Authorization</p>
<p class="p2"><br></p>
<p class="p1">How Login / Logout Works (Plain English)</p>
<p class="p1">- Customer login happens in modals (components/modals/CustomerLoginModal.jsx, components/modals/CustomerSignupModal.jsx) and uses Supabase Auth (email/password or OAuth).</p>
<p class="p1">- Business login happens on /business-auth/login and /business-auth/register and uses Supabase Auth (components/business-auth/*).</p>
<p class="p1">- OAuth callbacks go to /oauth/callback -&gt; /api/auth/callback, which exchanges the code, fetches the user role, then redirects to the correct dashboard (lib/auth/redirects.js).</p>
<p class="p1">- Logout clears Supabase cookies and local storage via /api/auth/logout and /api/logout.</p>
<p class="p2"><br></p>
<p class="p1">Where Sessions Live</p>
<p class="p1">- Supabase sessions are stored in cookies named like sb-&lt;project&gt;-auth-token plus standard Supabase cookies.</p>
<p class="p1">- Some auth flow state is stored in localStorage and sessionStorage (e.g., business auth redirect handoff, auth guard diagnostics).</p>
<p class="p2"><br></p>
<p class="p1">Where Session State Is Checked</p>
<p class="p1">- Server side: lib/auth/server.js (used in layouts).</p>
<p class="p1">- Middleware: middleware.js (checks for auth cookies on /customer/*, /business/*, /api/*).</p>
<p class="p1">- Client side: components/AuthProvider.jsx + components/auth/AuthRedirectGuard.jsx.</p>
<p class="p2"><br></p>
<p class="p1">Role Checks (Customer vs Business)</p>
<p class="p1">- Primary role source: public.users.role.</p>
<p class="p1">- Fallback: user.app_metadata.role from Supabase.</p>
<p class="p1">- Server layout enforcement: requireRole("customer") or requireRole("business").</p>
<p class="p2"><br></p>
<p class="p1">Common pitfall: A user can be authenticated but still get redirected if their users.role is missing or mismatched. The server guard in lib/auth/server.js will send them to the opposite dashboard.</p>
<p class="p2"><br></p>
<p class="p1">Known Failure Modes (Observed in Code)</p>
<p class="p1">- Navbar changes but page doesn’t redirect: client auth state updates but route not reloaded. Fallback guard does router.replace and then hard redirect.</p>
<p class="p1"><span class="Apple-converted-space">  </span>Files: components/auth/AuthRedirectGuard.jsx, components/AuthProvider.jsx</p>
<p class="p1">- Login “stuck” until refresh: cookie persistence or Safari storage issues; there are refresh token backoffs.</p>
<p class="p1"><span class="Apple-converted-space">  </span>Files: components/modals/CustomerLoginModal.jsx, components/modals/CustomerSignupModal.jsx, lib/supabaseClient.js</p>
<p class="p1">- Redirect loops after token refresh: middleware and client guards both redirect if auth cookies are invalid or refresh_token_already_used.</p>
<p class="p1"><span class="Apple-converted-space">  </span>Files: middleware.js, lib/supabase/middleware.js, app/api/auth/refresh/route.js</p>
<p class="p2"><br></p>
<p class="p1">High risk change: Editing middleware.js, lib/auth/server.js, or components/AuthProvider.jsx can lock out users or cause redirect loops.</p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p1">Data Model &amp; Supabase</p>
<p class="p2"><br></p>
<p class="p1">Key Tables (from migrations)</p>
<p class="p1">- users: all users (customer or business) + profile details</p>
<p class="p1">- listings: products/services posted by businesses</p>
<p class="p1">- saved_listings: customer saves</p>
<p class="p1">- businesses: legacy/secondary business table</p>
<p class="p1">- conversations, messages: messaging</p>
<p class="p1">- business_views: profile analytics</p>
<p class="p1">- carts, cart_items: shopping cart</p>
<p class="p1">- orders, order_items: customer orders</p>
<p class="p1">- vendor_members: users linked to vendors</p>
<p class="p1">- notifications: order status + events</p>
<p class="p1">- inventory_jobs: inventory sync queue</p>
<p class="p2"><br></p>
<p class="p1">RLS (Row Level Security) Summary – Plain English</p>
<p class="p1">- Listings: anyone can read; only owning business can insert/update/delete.</p>
<p class="p1">- Saved listings: only logged-in customer can insert/read their saves.</p>
<p class="p1">- Conversations/messages: only participants can read; customers can start; participants can send; recipients can mark read.</p>
<p class="p1">- Business views: anyone can insert; only business can read its own views.</p>
<p class="p1">- Carts/cart items: only logged-in customer can read/write.</p>
<p class="p1">- Orders/order items: customers can read/create own orders; vendors can read/update if member.</p>
<p class="p1">- Vendor members: owners can self-assign; members can read memberships.</p>
<p class="p1">- Notifications: only recipient can read/update.</p>
<p class="p2"><br></p>
<p class="p1">RLS policies live in supabase/migrations/*.sql.</p>
<p class="p2"><br></p>
<p class="p1">Common pitfall: There is no DELETE policy for saved_listings in migrations, but the UI deletes saved listings. This can cause delete failures when RLS is enforced.</p>
<p class="p2"><br></p>
<p class="p1">RLS Debug Checklist (Non-Technical)</p>
<p class="p1">1. Confirm the user is logged in (auth cookie exists).</p>
<p class="p1">2. Check the user role (customer vs business).</p>
<p class="p1">3. Verify the row is tied to the same user_id or business_id.</p>
<p class="p1">4. If an insert/update fails, verify a policy exists for that action.</p>
<p class="p1">5. If a server API works but the client doesn’t, it’s likely RLS (service role bypasses RLS).</p>
<p class="p1">6. If the table is missing in migrations, it may not exist in production.</p>
<p class="p1">7. Check Supabase logs for permission denied or RLS errors.</p>
<p class="p1">8. For storage errors, confirm bucket permissions and file size limits.</p>
<p class="p1">9. If data appears in one place but not another, confirm the query isn’t filtering by role or city.</p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p1">Storage &amp; Uploads</p>
<p class="p2"><br></p>
<p class="p1">Buckets Observed in Code</p>
<p class="p1">- listing-photos: listing images</p>
<p class="p1">- business-photos: business avatars/cover images</p>
<p class="p1">- business-gallery: business gallery images</p>
<p class="p1">- avatars: customer profile photos</p>
<p class="p2"><br></p>
<p class="p1">Upload Flow</p>
<p class="p1">- Uploads are direct from the browser using Supabase Storage.</p>
<p class="p1">- Files are saved to public buckets and read via public URLs.</p>
<p class="p1">- No signed URL flow is used.</p>
<p class="p2"><br></p>
<p class="p1">Timeouts / Size Limits</p>
<p class="p1">- Listing photo upload has a 20s timeout.</p>
<p class="p1">- uploadPublicImage enforces 8MB max + image type whitelist.</p>
<p class="p2"><br></p>
<p class="p1">Common pitfall: Upload succeeded but image doesn’t show usually means the stored URL is a bucket path, not a full public URL.</p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p1">Operational Flows (Step-by-Step)</p>
<p class="p2"><br></p>
<p class="p1">1) Create Listing (Business)</p>
<p class="p1">User action: Business clicks “Create listing”</p>
<p class="p1">Page: /business/listings/new</p>
<p class="p1">DB changes: Upload photos to listing-photos, insert row into listings</p>
<p class="p1">Policies: Listings insert allowed only for business user</p>
<p class="p1">Files to change:</p>
<p class="p1">- app/(business)/business/listings/new/page.jsx</p>
<p class="p1">- supabase/migrations/20251205204210_init.sql</p>
<p class="p1">- lib/storageUpload.js</p>
<p class="p2"><br></p>
<p class="p1">2) Publish Listing</p>
<p class="p1">There is no separate publish flag in this repo; publish = insert listing.</p>
<p class="p2"><br></p>
<p class="p1">3) Customer Browses Listings</p>
<p class="p1">User action: Visits /customer/home or /listings</p>
<p class="p1">Page: /customer/home (uses /api/home-listings)</p>
<p class="p1">DB changes: Reads listings</p>
<p class="p1">Files to change:</p>
<p class="p1">- app/(customer)/customer/home/CustomerHomeClient.jsx</p>
<p class="p1">- app/api/home-listings/route.js</p>
<p class="p1">- app/(public)/listings/page.js</p>
<p class="p2"><br></p>
<p class="p1">4) Save Listing</p>
<p class="p1">User action: Clicks “Save” on listing</p>
<p class="p1">Page: /listings/[id] or /customer/listings/[id]</p>
<p class="p1">DB changes: Insert/delete saved_listings</p>
<p class="p1">Policies: Insert allowed for own user; DELETE policy not in migrations</p>
<p class="p1">Files to change:</p>
<p class="p1">- app/(public)/listings/[id]/page.js</p>
<p class="p1">- app/(customer)/customer/saved/CustomerSavedClient.jsx</p>
<p class="p1">- supabase/migrations/20251205204210_init.sql</p>
<p class="p2"><br></p>
<p class="p1">5) Leave a Review</p>
<p class="p1">User action: Review form on business profile</p>
<p class="p1">Page: /b/[id] or /customer/b/[id]</p>
<p class="p1">DB changes: Insert/update/delete business_reviews</p>
<p class="p1">Policies: Not defined in migrations (unknown)</p>
<p class="p1">Files to change:</p>
<p class="p1">- components/publicBusinessProfile/BusinessReviewsPanel.jsx</p>
<p class="p1">- components/business/profile/ReviewsPanel.jsx</p>
<p class="p1">- app/(public)/(marketing)/b/[id]/page.jsx</p>
<p class="p2"><br></p>
<p class="p1">6) Create Order (Delivery / Pickup)</p>
<p class="p1">User action: Add to cart -&gt; checkout</p>
<p class="p1">Pages: /cart -&gt; /checkout -&gt; /orders/[order_number]</p>
<p class="p1">DB changes: carts/cart_items update; orders + order_items insert; carts.status set to submitted; notifications/messages created</p>
<p class="p1">Policies: Customers can create orders; vendors can read/update orders</p>
<p class="p1">Files to change:</p>
<p class="p1">- app/api/cart/route.js</p>
<p class="p1">- components/cart/CartProvider.jsx</p>
<p class="p1">- app/checkout/page.js</p>
<p class="p1">- app/api/orders/route.js</p>
<p class="p1">- app/api/business/orders/route.js</p>
<p class="p2"><br></p>
<p class="p1">7) Messaging Flow</p>
<p class="p1">User action: “Message business” from listing or order update</p>
<p class="p1">Pages: /customer/messages/*, /business/messages/*</p>
<p class="p1">DB changes: RPC get_or_create_conversation; insert messages; trigger updates conversations counters</p>
<p class="p1">Policies: Only participants can read/send</p>
<p class="p1">Files to change:</p>
<p class="p1">- lib/messages.ts</p>
<p class="p1">- app/(customer)/customer/messages/[conversationId]/page.js</p>
<p class="p1">- app/(business)/business/messages/[conversationId]/page.js</p>
<p class="p1">- supabase/migrations/20251207090000_add_messaging.sql</p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p1">Where to Make Updates</p>
<p class="p2"><br></p>
<p class="p1">Where to update: Use the file paths below directly. These are safe entry points for non-dev changes (copy/labels) vs risky changes (auth/RLS).</p>
<p class="p2"><br></p>
<p class="p1">Marketing / Copy (Safe)</p>
<p class="p1">- Homepage hero text and CTA: components/marketing/HomePageClient.jsx</p>
<p class="p1">- Homepage banner (CMS): components/HomeBanner.tsx + Strapi content</p>
<p class="p1">- Business marketing page: app/(public)/business/page.js</p>
<p class="p1">- Public about/terms/privacy: app/(public)/(marketing)/about/page.js, app/(public)/(marketing)/terms/page.js, app/(public)/(marketing)/privacy/page.js</p>
<p class="p2"><br></p>
<p class="p1">Navigation / Links</p>
<p class="p1">- Public/global header: components/nav/GlobalHeader.jsx</p>
<p class="p1">- Business navbar: components/navbars/BusinessNavbar.jsx</p>
<p class="p1">- Customer navbar: components/navbars/CustomerNavbar.jsx</p>
<p class="p2"><br></p>
<p class="p1">Listings &amp; Fields</p>
<p class="p1">- Listing form fields (create): app/(business)/business/listings/new/page.jsx</p>
<p class="p1">- Listing form fields (edit): app/(business)/business/listings/[id]/edit/page.js</p>
<p class="p1">- Listing display cards: app/(public)/listings/page.js, components/publicBusinessProfile/BusinessListingsGrid.jsx</p>
<p class="p2"><br></p>
<p class="p1">Categories</p>
<p class="p1">- Category list: lib/businessCategories.js</p>
<p class="p1">- Category filters: app/(customer)/customer/nearby/NearbyBusinessesClient.jsx, app/(public)/listings/page.js</p>
<p class="p2"><br></p>
<p class="p1">Reviews (Display Name or Rules)</p>
<p class="p1">- Display name format: components/publicBusinessProfile/BusinessReviewsPanel.jsx (function formatReviewer)</p>
<p class="p1">- Business reply handling: components/business/profile/ReviewsPanel.jsx</p>
<p class="p2"><br></p>
<p class="p1">Orders &amp; Status Labels</p>
<p class="p1">- Status labels/descriptions: lib/orders.js</p>
<p class="p1">- Business order workflow: app/api/business/orders/route.js</p>
<p class="p1">- Badge rendering: components/orders/OrderStatusBadge.jsx</p>
<p class="p1">- DB enum values: supabase/migrations/20260109120000_add_cart_and_orders.sql, supabase/migrations/20260109140000_add_vendor_members_and_notifications.sql</p>
<p class="p2"><br></p>
<p class="p1">Business Onboarding Copy / Fields</p>
<p class="p1">- Business onboarding form &amp; copy: app/(business)/business/onboarding/page.js</p>
<p class="p1">- Address lookup behavior: same file + NEXT_PUBLIC_MAPBOX_TOKEN env var</p>
<p class="p2"><br></p>
<p class="p1">High risk change: Anything in supabase/migrations/*.sql, middleware.js, or lib/auth/server.js can break login or block access.</p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p1">Admin/Operator Playbook</p>
<p class="p2"><br></p>
<p class="p1">Troubleshooting Without Coding</p>
<p class="p1">- Login issues: Check cookies + refresh token errors in browser console.</p>
<p class="p1">- Data missing: Check if the user is logged in and has correct role.</p>
<p class="p1">- Saved listings not deleting: Likely missing RLS delete policy.</p>
<p class="p1">- Messages not appearing: Ensure conversation exists and RLS allows access.</p>
<p class="p2"><br></p>
<p class="p1">Where to Check Logs</p>
<p class="p1">- Browser console: Auth and messaging diagnostics; look for [AUTH_DIAG], [MSG_DIAG].</p>
<p class="p1">- Server logs: Next.js server output; watch for API errors.</p>
<p class="p1">- Supabase logs: Auth logs, database logs (RLS denies), storage logs.</p>
<p class="p2"><br></p>
<p class="p1">RLS vs Frontend Bug Signals</p>
<p class="p1">- RLS issue: API returns 401/403; data visible with service role but not client.</p>
<p class="p1">- Frontend issue: No network request fired, or response is OK but UI doesn’t update.</p>
<p class="p1">- Session issue: Auth cookies missing or refresh_token_already_used.</p>
<p class="p2"><br></p>
<p class="p1">Glossary (Plain English)</p>
<p class="p1">- Session: proof that a user is logged in (stored in cookies).</p>
<p class="p1">- RLS: Supabase rules that decide who can read/write rows.</p>
<p class="p1">- Bucket: a folder in Supabase Storage for images/files.</p>
<p class="p1">- Route: a page URL in the app (e.g., /customer/home).</p>
<p class="p1">- Route Handler: backend API endpoint under /api/*.</p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p1">Open Questions / Assumptions</p>
<p class="p1">1. Reviews, galleries, announcements tables (business_reviews, business_gallery_photos, business_announcements) are referenced in code but not present in supabase/migrations. Are these in production?</p>
<p class="p1">2. Several user profile columns are referenced (cover_photo_url, hours_json, social_links_json, publish flags) but not in migrations. Confirm schema source of truth.</p>
<p class="p1">3. The IDE shows 20260111120000_allow_notification_deletes.sql but it is not in this repo. Was it deleted or moved?</p>
<p class="p1">4. Public routes like /cart, /checkout, /profile are not guarded by middleware. Is this intentional?</p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p1">10-Item Checklist</p>
<p class="p1">1. Understand the role guard flow (middleware.js, lib/auth/server.js).</p>
<p class="p1">2. Review Supabase RLS policies in supabase/migrations/*.sql.</p>
<p class="p1">3. Confirm users.role values for customer vs business.</p>
<p class="p1">4. Verify storage buckets exist (listing-photos, business-photos, business-gallery, avatars).</p>
<p class="p1">5. Check the listing creation flow (app/(business)/business/listings/new/page.jsx).</p>
<p class="p1">6. Confirm order flow (app/api/cart/route.js -&gt; app/api/orders/route.js).</p>
<p class="p1">7. Confirm business order updates and inventory decrement (app/api/business/orders/route.js).</p>
<p class="p1">8. Verify messaging RPC and policies (supabase/migrations/20251207090000_add_messaging.sql).</p>
<p class="p1">9. Keep Strapi banner integration working (lib/strapi.ts, components/HomeBanner.tsx).</p>
<p class="p1">10. Document any missing tables/columns that exist in production but not in migrations.</p>
</body>
</html>
